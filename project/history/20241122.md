# Next.jsプロジェクトにTypeScriptを追加する
## TypeScriptの依存関係を確認
`npm list typescript`
```
nameMacBook-Pro project % npm list typescript
next-project@0.1.0 /Users/name_1/Desktop/_workspace_tec/workspace_React-todo_1/React-todo_1/project
└── typescript@5.6.3 extraneous

nameMacBook-Pro project % 

```
TypeScriptはインストールされているようですが、"extraneous"（不要な）としてマークされています。これはpackage.jsonに正しく登録されていない状態です。
再度インストールを実行してください：

# Next.jsプロジェクトにTypeScriptを追加する
```
nameMacBook-Pro project % npm install --save-dev typescript @types/react @types/node @types/react-dom

up to date, audited 149 packages in 2s

35 packages are looking for funding
  run `npm fund` for details

2 high severity vulnerabilities

To address issues that do not require attention, run:
  npm audit fix

To address all issues, run:
  npm audit fix --force

Run `npm audit` for details.
nameMacBook-Pro project % 
```
# インストール後、tsconfig.jsonを作成する
`npx tsc --init `
```
nameMacBook-Pro project % npm tsc --init
Unknown command: "tsc"

To see a list of supported npm commands, run:
  npm help
nameMacBook-Pro project % npx tsc --init                                                             

Created a new tsconfig.json with:                                                                                       
                                                                                                                     TS 
  target: es2016
  module: commonjs
  strict: true
  esModuleInterop: true
  skipLibCheck: true
  forceConsistentCasingInFileNames: true


You can learn more at https://aka.ms/tsconfig
nameMacBook-Pro project % 
```
- npxはパッケージの実行に特化したツールで、ローカルのnode_modules/.binにあるtscバイナリを直接実行できる
- npmはパッケージ管理が主目的で、直接バイナリを実行する機能はない

# src folder配下の`.js`ファイルまたは `.jsx`ファイルを全て`.tsx`に変更
```
nameMacBook-Pro project % find src \( -name "*.js" -o -name "*.jsx" \) -exec sh -c 'mv "$1" "${1%.*}.tsx"' _ {} \;
nameMacBook-Pro project % 

```
# Supabaseのインストール
```
nameMacBook-Pro React-todo_1 % cd project 
nameMacBook-Pro project % npm install @supabase/supabase-js

up to date, audited 162 packages in 5s

35 packages are looking for funding
  run `npm fund` for details

2 high severity vulnerabilities

To address issues that do not require attention, run:
  npm audit fix

To address all issues, run:
  npm audit fix --force

Run `npm audit` for details.
nameMacBook-Pro project % 
```
# Supabaseの設定ファイル`src/supabase.js`を追加する
```
nameMacBook-Pro project % touch src/supabase.js
```
# `.env`を追加
```
nameMacBook-Pro project % touch .env
```

# Supabaseとデータを連携させる
## **supabase table*
- テーブル名 : todo-pj-table
```
| Column     | Type         | Constraints                             |
|------------|--------------|------------------------------------------|
| id         | uuid         | PRIMARY KEY, DEFAULT uuid_generate_v4() |
| title      | varchar      | NOT NULL                                |
| details    | text         |                                         |
| status     | varchar      | NOT NULL, DEFAULT '未着手'               |
| dueDate    | date         |                                         |
| createdAt  | timestamptz  | NOT NULL, DEFAULT now()                 |
| updatedAt  | timestamptz  | NOT NULL, DEFAULT now()                 |

```
## コンソールエラーあり 
### エラーの原因
エラーの主な原因は、新しいTODOを追加するときに、id フィールドが null として挿入されていることです。id カラムは NOT NULL 制約があり、デフォルトで uuid_generate_v4() 関数によって自動生成される設定になっています。

しかし、Supabase（PostgreSQL）では、INSERT文で明示的に id に null を挿入しようとすると、デフォルト値は適用されず、NOT NULL制約違反が発生します。

問題の詳細
newTodo オブジェクトに id フィールドが含まれており、その値が null になっている可能性があります。これにより、挿入時に id が null として扱われ、エラーが発生します。

解決策
newTodo オブジェクトから id フィールドを除外して、挿入時に id を明示的に設定しないようにします。 そうすることで、データベース側で id が自動的に生成されます。

SupabaseでDBデータが空で返ってくる #React - Qiita
https://qiita.com/Sicut_study/items/1ab87c0c182fc42ad824

---
# ToDo
- [ ] 期限日の入力バリデーションを追加
- [ ] 「更新日」が、時間も反映されるようにする

# React(SPA)アプリをFirebase Hostingにデプロイ
https://zenn.dev/yumemi_inc/articles/2020-10-06-react-firebase-deploy

# Firebase SDK の追加
```
nameMacBook-Pro project % npm install firebase         

up to date, audited 244 packages in 2s

36 packages are looking for funding
  run `npm fund` for details

2 high severity vulnerabilities

To address issues that do not require attention, run:
  npm audit fix

To address all issues, run:
  npm audit fix --force

Run `npm audit` for details.
nameMacBook-Pro project % 
```
# Firebase CLI のインストール
```
nameMacBook-Pro project % npm install -g firebase-tools

changed 644 packages in 8s

69 packages are looking for funding
  run `npm fund` for details
nameMacBook-Pro project % 

```
# Firebase Hosting へのデプロイ
```
nameMacBook-Pro project % firebase login
Already logged in as *********@gmail.com
nameMacBook-Pro project % firebase init

     ######## #### ########  ######## ########     ###     ######  ########
     ##        ##  ##     ## ##       ##     ##  ##   ##  ##       ##
     ######    ##  ########  ######   ########  #########  ######  ######
     ##        ##  ##    ##  ##       ##     ## ##     ##       ## ##
     ##       #### ##     ## ######## ########  ##     ##  ######  ########

You're about to initialize a Firebase project in this directory:

  /Users/name_1/Desktop/_workspace_tec/workspace_React-todo_1/React-todo_1/project

? Which Firebase features do you want to set up for this directory? Press Space to select features, then Enter to confirm your choices. Realtime Database: Configure a security rules file for Realtime 
Database and (optionally) provision default instance

=== Project Setup

First, let's associate this project directory with a Firebase project.
You can create multiple project aliases by running firebase use --add, 
but for now we'll just set up a default project.

? Please select an option: Use an existing project
? Select a default Firebase project for this directory: tec-support-pj (tec-support-pj)
i  Using project tec-support-pj (tec-support-pj)

=== Database Setup
i  database: ensuring required API firebasedatabase.googleapis.com is enabled...
⚠  database: missing required API firebasedatabase.googleapis.com. Enabling now...
✔  database: required API firebasedatabase.googleapis.com is enabled

? It seems like you haven’t initialized Realtime Database in your project yet. Do you want to set it up? Yes
? Please choose the location for your default Realtime Database instance: asia-southeast1
✔ Creating your default Realtime Database instance: tec-support-pj-default-rtdb

Firebase Realtime Database Security Rules allow you to define how your data should be
structured and when your data can be read from and written to.

? What file should be used for Realtime Database Security Rules? database.rules.json
✔  Database Rules for tec-support-pj-default-rtdb have been written to database.rules.json.
Future modifications to database.rules.json will update Realtime Database Security Rules when you run
firebase deploy.

i  Writing configuration info to firebase.json...
i  Writing project information to .firebaserc...

✔  Firebase initialization complete!
nameMacBook-Pro project % 
nameMacBook-Pro project % firebase deploy

=== Deploying to 'tec-support-pj'...

i  deploying database
i  database: checking rules syntax...
✔  database: rules syntax for database tec-support-pj-default-rtdb is valid
i  database: releasing rules...
✔  database: rules for database tec-support-pj-default-rtdb released successfully

✔  Deploy complete!

Project Console: https://console.firebase.google.com/project/tec-support-pj/overview
nameMacBook-Pro project % 
```
# Firebase SDK の初期化を行うファイルを作成
## `.env`fileに設定を追加
```
//.env
# Firebase
REACT_APP_APP_KEY=※apikey
REACT_APP_AUTH_DOMAIN=※authDomain
REACT_APP_DATABASE_URL=※databaseURL
REACT_APP_PROJECT_ID=※projectId
REACT_APP_STORAGEBUCKET=※storageBucket
REACT_APP_MESSAGING_SENDER_ID=※messagingSenderId
REACT_APP_APP_ID=※appId
REACT_APP_MEASUREMENT_ID=※measurementId

```
- https://console.firebase.google.com/u/0/project/tec-support-pj/settings/general/web:NTI4MWRjNjEtYzZmYy00NmYzLWEyMjktMjUyZTcyNmI2N2Mw
---

# ToDo
- [ ] 期限日の入力バリデーションを追加
- [ ] 「更新日」が、時間も反映されるようにする
---
# Firebase Hosting へデプロイ
- [ ] ビルドして、その生成物をFirebaseへデプロイします。

## ビルド
```
npm run build
```
### 全ての Firebase サービスリソースをデプロイ
```
firebase deploy
```
- [x] ↑どこのfileにビルドされるのか? PJの存在場所の階層が違う場合は、設定が必要かを確認する.
### Hosting のリソースのみデプロイ + コメント
```
firebase deploy --only hosting -m "※任意のコメント"
```
# ビルドする
## エラー発生
```
nameMacBook-Pro React-todo_1 % cd project 
nameMacBook-Pro project % npm run build

> next-project@0.1.0 build
> next build

   ▲ Next.js 14.0.4
   - Environments: .env
   - Experiments (use at your own risk):
     · esmExternals

 ✓ Creating an optimized production build    
 ✓ Compiled successfully
   Linting and checking validity of types  ..Failed to compile.

./src/app/layout.tsx:11:38
Type error: Binding element 'children' implicitly has an 'any' type.

   9 | }
  10 |
> 11 | export default function RootLayout({ children }) {
     |                                      ^
  12 |   return (
  13 |     <html lang="en">
  14 |       <body className={inter.className}>{children}</body>
   Linting and checking validity of types  ...%                                                                                        
nameMacBook-Pro project % 
```
## エラー解消
1.  ReactNodeをインポートする
2. プロパティの型定義: `RootLayout`コンポーネントのプロパティを定義するインターフェースを作成し、`children`の型を`ReactNode`と指定
3. 型注釈の追加: 関数の引数である`{ children }`に対して、先ほど定義した`RootLayoutProps`を型注釈として追加します。
```
nameMacBook-Pro project % npm run build

> next-project@0.1.0 build
> next build

   ▲ Next.js 14.0.4
   - Environments: .env
   - Experiments (use at your own risk):
     · esmExternals

 ✓ Creating an optimized production build    
 ✓ Compiled successfully
 ✓ Linting and checking validity of types    
 ✓ Collecting page data    
 ✓ Generating static pages (4/4) 
 ✓ Collecting build traces    
 ✓ Finalizing page optimization    

Route (app)                              Size     First Load JS
┌ ○ /                                    36.4 kB         118 kB
└ ○ /_not-found                          875 B          82.8 kB
+ First Load JS shared by all            81.9 kB
  ├ chunks/938-5741492e06bfaff9.js       26.7 kB
  ├ chunks/fd9d1056-891a55ec38545216.js  53.3 kB
  ├ chunks/main-app-c5f850f29b4c46b3.js  220 B
  └ chunks/webpack-7e716cfaa8147133.js   1.73 kB


ƒ Middleware                             39.4 kB

○  (Static)  prerendered as static content

nameMacBook-Pro project % 
```
# Firebase Hosting へデプロイでエラー
## PJの存在場所の階層の設定を追加する
```shell
nameMacBook-Pro project % firebase deploy

=== Deploying to 'tec-support-pj'...

i  deploying database
i  database: checking rules syntax...
✔  database: rules syntax for database tec-support-pj-default-rtdb is valid
i  database: releasing rules...
✔  database: rules for database tec-support-pj-default-rtdb released successfully

✔  Deploy complete!

Project Console: https://console.firebase.google.com/project/tec-support-pj/overview
nameMacBook-Pro project % firebase deploy --only hosting -m "20241127初期デプロイ"

Error: Cannot understand what targets to deploy/serve. No targets in firebase.json match '--only hosting'.
nameMacBook-Pro project % firebase deploy --only hosting -m "20241127初期デプロイ"

=== Deploying to 'tec-support-pj'...

i  deploying hosting
i  hosting[tec-support-pj]: beginning deploy...

Error: Directory 'public' for Hosting does not exist.

Having trouble? Try firebase [command] --help
nameMacBook-Pro project % 

```
```firebase.json
{
  "hosting": {
    "source": ".",
    "frameworksBackend": {},
    "ignore": ["firebase.json", "**/.*", "**/node_modules/**"]
  },
  "database": {
    "rules": "database.rules.json"
  }
}
```
- "source": "." は、プロジェクトのルートディレクトリ（内部の project ディレクトリ）を指しています。
- "frameworksBackend": {} を追加することで、Firebase が Next.js プロジェクトであることを認識し、適切なビルドとデプロイを行います。
```
nameMacBook-Pro project % firebase deploy --only hosting -m "20241127初期デプロイ"

Error: Cannot deploy a web framework from source because the experiment webframeworks is not enabled. To enable webframeworks run firebase experiments:enable webframeworks
nameMacBook-Pro project % firebase deploy                                         

Error: Cannot deploy a web framework from source because the experiment webframeworks is not enabled. To enable webframeworks run firebase experiments:enable webframeworks

Having trouble? Try firebase [command] --help
nameMacBook-Pro project % 
```

```
nameMacBook-Pro React-todo_1 % cd project                               
nameMacBook-Pro project % firebase experiments:enable webframeworks
Enabled experiment webframeworks
nameMacBook-Pro project % npm install -g firebase-tools

changed 644 packages in 20s

69 packages are looking for funding
  run `npm fund` for details
nameMacBook-Pro project % firebase --version
13.27.0
nameMacBook-Pro project % firebase deploy --only hosting -m "20241127初期デプロイ"

   Thank you for trying our early preview of Next.js support on Firebase Hosting.
   During the preview, support is best-effort and breaking changes can be expected. Proceed with caution.

   Documentation: https://firebase.google.com/docs/hosting/frameworks/nextjs
   File a bug: https://github.com/firebase/firebase-tools/issues/new?template=bug_report.md
   Submit a feature request: https://github.com/firebase/firebase-tools/issues/new?template=feature_request.md

   We'd love to learn from you. Express your interest in helping us shape the future of Firebase Hosting: https://goo.gle/41enW5X

   ▲ Next.js 14.0.4

   - Environments: .env
   - Experiments (use at your own risk):
     · esmExternals

   Creating an optimized production build ...

 ✓ Compiled successfully

   Linting and checking validity of types ...

   Collecting page data ...

   Generating static pages (0/4) ...

   Generating static pages (1/4) 

   Generating static pages (2/4) 
   Generating static pages (3/4) 

 ✓ Generating static pages (4/4) 

   Finalizing page optimization ...

   Collecting build traces ...



Route (app)                              Size     First Load JS
┌ ○ /                                    36.4 kB         118 kB
└ ○ /_not-found                          875 B          82.8 kB
+ First Load JS shared by all            81.9 kB
  ├ chunks/938-5741492e06bfaff9.js       26.7 kB
  ├ chunks/fd9d1056-891a55ec38545216.js  53.3 kB
  ├ chunks/main-app-c5f850f29b4c46b3.js  220 B
  └ chunks/webpack-7e716cfaa8147133.js   1.73 kB


ƒ Middleware                             39.4 kB


○  (Static)  prerendered as static content


Building a Cloud Function to run this application. This is needed due to:
 • middleware

Failed to find esbuild with npx which: Error: Command failed: npx which esbuild
esbuild not found, installing...

added 2 packages, and audited 246 packages in 1s

36 packages are looking for funding
  run `npm fund` for details

2 high severity vulnerabilities

To address issues that do not require attention, run:
  npm audit fix

To address all issues, run:
  npm audit fix --force

Run `npm audit` for details.
npm WARN deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
npm WARN deprecated google-p12-pem@4.0.1: Package is no longer maintained
npm WARN deprecated glob@8.1.0: Glob versions prior to v9 are no longer supported

added 375 packages in 14s

32 packages are looking for funding
  run `npm fund` for details

Error: Failed to list functions for tec-support-pj
nameMacBook-Pro project % 
```

```
nameMacBook-Pro project % firebase init functions

     ######## #### ########  ######## ########     ###     ######  ########
     ##        ##  ##     ## ##       ##     ##  ##   ##  ##       ##
     ######    ##  ########  ######   ########  #########  ######  ######
     ##        ##  ##    ##  ##       ##     ## ##     ##       ## ##
     ##       #### ##     ## ######## ########  ##     ##  ######  ########

You're about to initialize a Firebase project in this directory:

  /Users/name_1/Desktop/_workspace_tec/workspace_React-todo_1/React-todo_1/project

Before we get started, keep in mind:

  * You are initializing within an existing Firebase project directory


=== Project Setup

First, let's associate this project directory with a Firebase project.
You can create multiple project aliases by running firebase use --add, 
but for now we'll just set up a default project.

i  Using project tec-support-pj (tec-support-pj)

=== Functions Setup
Let's create a new codebase for your functions.
A directory corresponding to the codebase will be created in your project
with sample code pre-configured.

See https://firebase.google.com/docs/functions/organize-functions for
more information on organizing your functions using codebases.

Functions can be deployed with firebase deploy.

? What language would you like to use to write Cloud Functions? TypeScript
? Do you want to use ESLint to catch probable bugs and enforce style? Yes
✔  Wrote functions/package.json
✔  Wrote functions/.eslintrc.js
✔  Wrote functions/tsconfig.json
✔  Wrote functions/tsconfig.dev.json
✔  Wrote functions/src/index.ts
✔  Wrote functions/.gitignore
? Do you want to install dependencies with npm now? Yes
npm WARN deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
npm WARN deprecated rimraf@3.0.2: Rimraf versions prior to v4 are no longer supported
npm WARN deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm WARN deprecated @humanwhocodes/object-schema@2.0.3: Use @eslint/object-schema instead
npm WARN deprecated @humanwhocodes/config-array@0.13.0: Use @eslint/config-array instead
npm WARN deprecated eslint@8.57.1: This version is no longer supported. Please see https://eslint.org/version-support for other options.

added 647 packages, and audited 648 packages in 13s

137 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

i  Writing configuration info to firebase.json...
i  Writing project information to .firebaserc...

✔  Firebase initialization complete!
nameMacBook-Pro project % 
```
